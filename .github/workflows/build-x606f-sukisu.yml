name: Build ARM64 Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev make gcc-aarch64-linux-gnu

      - name: Set TOPDIR
        run: |
          export TOPDIR=$(pwd)
          echo "TOPDIR=$TOPDIR" >> $GITHUB_ENV

      - name: Detect defconfig
        id: detect
        run: |
          cd $TOPDIR
          if [ ! -d arch/arm64/configs ]; then
            echo "❌ arch/arm64/configs not found"
            exit 1
          fi

          DEFCONFIG=$(find arch/arm64/configs -maxdepth 1 -name "*_defconfig" | head -n 1 | xargs basename)
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG="defconfig"
          fi

          echo "✅ Using defconfig: $DEFCONFIG"
          echo "defconfig=$DEFCONFIG" >> $GITHUB_OUTPUT

      - name: Fix permissions
        run: |
          cd $TOPDIR
          chmod +x scripts/* || true
          chmod +x scripts/config || true

      - name: Build kernel
        run: |
          cd $TOPDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          make ${{ steps.detect.outputs.defconfig }}
          make -j$(nproc)

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: |
            ${{ env.TOPDIR }}/arch/arm64/boot/Image.gz*
            ${{ env.TOPDIR }}/arch/arm64/boot/Image*
