name: Build X606F Kernel with SukiSU

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl build-essential bc bison flex libncurses5-dev libssl-dev zip unzip ccache

      - name: Fetch kernel source
        run: |
          chmod +x build/scripts/fetch_sources.sh
          bash build/scripts/fetch_sources.sh

      - name: Apply SukiSU patches
        run: |
          chmod +x build/scripts/patch_kernel.sh
          bash build/scripts/patch_kernel.sh

      - name: Prepare toolchain
        run: |
          chmod +x build/scripts/prepare_toolchain.sh
          bash build/scripts/prepare_toolchain.sh

      - name: Copy defconfig to kernel tree
        run: |
          KERNEL_DIR=$(find . -type d -path "*/arch/arm64/configs" | head -n 1 | sed 's|/arch/arm64/configs||')
          echo "Kernel source detected at: $KERNEL_DIR"
          cp configs/x606f_sukisu_defconfig $KERNEL_DIR/arch/arm64/configs/

      - name: Build kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export DEFCONFIG=x606f_sukisu_defconfig
          chmod +x build/build.sh
          bash build/build.sh

      - name: Package AnyKernel3 ZIP
        run: |
          chmod +x build/scripts/package_ak3.sh
          bash build/scripts/package_ak3.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: x606f-sukisu-kernel
          path: output/*.zip

      - name: Upload to GitHub Releases
        uses: ncipollo/release-action@v1
        with:
          artifacts: "output/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "build-${{ github.run_number }}"
          name: "X606F Kernel Build #${{ github.run_number }}"
          body: |
            âœ… Build completed for Lenovo X606F with SukiSU root patch.
            - DEFCONFIG: x606f_sukisu_defconfig
            - Toolchain: Clang/GCC (default from scripts)
            - Output: AnyKernel3 flashable ZIP
