name: Build ARM64 Kernel (Auto Detect)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex \
            libssl-dev make gcc-aarch64-linux-gnu

      - name: Prepare kernel source
        run: |
          if [ -f kernel.tgz ]; then
            echo "âœ… Found kernel.tgz, extracting..."
            mkdir kernel
            tar -xf kernel.tgz -C kernel --strip-components=1
            echo "TOPDIR=$(pwd)/kernel" >> $GITHUB_ENV
          elif [ -d kernel-4.9 ]; then
            echo "âœ… Found kernel-4.9 directory"
            echo "TOPDIR=$(pwd)/kernel-4.9" >> $GITHUB_ENV
          else
            echo "âš ï¸ Using repository root as kernel source"
            echo "TOPDIR=$(pwd)" >> $GITHUB_ENV
          fi

      - name: Detect defconfig
        id: detect
        run: |
          cd $TOPDIR
          if [ ! -d arch/arm64/configs ]; then
            echo "âŒ ERROR: arch/arm64/configs not found"
            exit 1
          fi

          DEFCONFIG=$(find arch/arm64/configs -maxdepth 1 -name "*_defconfig" | head -n 1 | xargs basename)
          if [ -z "$DEFCONFIG" ]; then
            echo "âš ï¸ No *_defconfig found, defaulting to defconfig"
            DEFCONFIG="defconfig"
          fi

          echo "âœ… Using defconfig: $DEFCONFIG"
          echo "defconfig=$DEFCONFIG" >> $GITHUB_OUTPUT

      - name: Build kernel
        run: |
          cd $TOPDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          echo "ğŸ—ï¸ Running make ${{ steps.detect.outputs.defconfig }}"
          make ${{ steps.detect.outputs.defconfig }}
          echo "ğŸ—ï¸ Building kernel image"
          make -j$(nproc)

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: |
            ${{ env.TOPDIR }}/arch/arm64/boot/Image*
